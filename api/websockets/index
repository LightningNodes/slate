<h1 id='web-sockets'>Web Sockets</h1>

<p>WebSockets are used to provide real-time updates and maintain a continuous connection between clients (traders) and servers (exchanges). </p>

<p>Here&#39;s how different web sockets work:</p>

<h2 id="authenticated-web-sockets">Authenticated Web Sockets</h2>

<p>Authenticated WebSockets require user validation to ensure that only authorized users can access the data or functionality provided such as receiving real-time updates about a trader&#39;s account.</p>

<p>For example,  balance changes, order executions, or margin updates.</p>

<aside class="notice"> Notes:
<ul>
  <li>Authenticated Web Socket stream base URL <code>https://fawss.pi42.com/auth-stream </code></li>
  <li>Requires listenkey that can be obtained from the <a href="#create-listen-key">Create Listen Key API</a></li>
</ul>
</aside>

<p>The WebSocket client connects to a server using a listen key and listens for various events related to trading activities and session management. Each event handler logs specific information when the event is received.</p>

<p>Event listeners are described below:</p>

<table>
        <thead>
            <tr>
                <th>Event</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>connect</td>
                <td>Triggered when the connection to the WebSocket server is open.</td>
            </tr>
            <tr>
                <td>newPosition</td>
                <td>Triggered when a new position is received from the server.</td>
            </tr>
            <tr>
                <td>orderFilled</td>
                <td>Triggered when an order is completely filled.</td>
            </tr>
            <tr>
                <td>orderPartiallyFilled</td>
                <td>Triggered when an order is partially filled.</td>
            </tr>
            <tr>
                <td>orderCancelled</td>
                <td>Triggered when an order is cancelled.</td>
            </tr>
            <tr>
                <td>orderFailed</td>
                <td>Triggered when an order fails.</td>
            </tr>
            <tr>
                <td>newOrder</td>
                <td>Triggered when a new order is created.</td>
            </tr>
            <tr>
                <td>updatePosition</td>
                <td>Triggered when a position is updated.</td>
            </tr>
            <tr>
                <td>closePosition</td>
                <td>Triggered when a position is closed.</td>
            </tr>
            <tr>
                <td>balanceUpdate</td>
                <td>Triggered when the balance is updated.</td>
            </tr>
            <tr>
                <td>newTrade</td>
                <td>Triggered when a new trade occurs.</td>
            </tr>
            <tr>
                <td>sessionExpired</td>
                <td>Triggered when the session expires.</td>
            </tr>
            <tr>
                <td>disconnect</td>
                <td>Triggered when the connection to the WebSocket server is closed.</td>
            </tr>
        </tbody>
</table>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="kd">const</span> <span class="nx">serverUrl</span> <span class="o">=</span> <span class="s2">`https://fawss.pi42.com/auth-stream/</span><span class="p">${</span><span class="nx">listenKey</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

<span class="c1">// Create a new socket connection</span>
<span class="kd">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="nx">serverUrl</span><span class="p">);</span>

<span class="c1">// Event listener for when the connection is open</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connect</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Connected to WebSocket server</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Event listener for messages from the server</span>

<span class="c1">// Event listener for newPosition events</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">newPosition</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">New position received:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for order filled event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">orderFilled</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Order filled:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for order partially filled event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">orderPartiallyFilled</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Order partially filled:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for order cancelled event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">orderCancelled</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Order cancelled:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for order failed event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">orderFailed</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Order failed:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for new order event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">newOrder</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">New order:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for update position event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">updatePosition</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Position updated:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for close position event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">closePosition</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Position closed:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for balance update event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">balanceUpdate</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Balance updated:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for new trade event</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">newTrade</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">New trade:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Listen for session expiry</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">sessionExpired</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Session Expired:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Event listener for when the connection is closed</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">disconnect</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Disconnected from WebSocket server</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="public-web-sockets">Public Web Sockets</h2>

<p>Public WebSockets are open to all clients and do not require authentication to establish a connection. They are useful for scenarios where the data being transmitted is not sensitive or where the application does not require user-specific interactions.</p>

<p>For example, to receive real-time updates on market data such as price changes, order book depth, and trade history without requiring authentication.</p>

<aside class="notice">

  Public Web Socket URL <code>https://fawss.pi42.com/</code>

</aside>

<p>Once connected, users can subscribe to different topics mentioned below:</p>

<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Example</th>
            <th>Listening Topic</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>contract_pair@depth_minGrouping</td>
            <td>btcinr@depth
            _
            0.1</td>
            <td>depthUpdate</td>
        </tr>
        <tr>
            <td>contract
            _pair@kline
            _
            interval</td>
            <td>btcinr@kline
            _
            1m</td>
            <td>kline</td>
        </tr>
        <tr>
            <td>contract
            _pair@markPrice</td>
            <td>btcinr@markPrice</td>
            <td>markPriceUpdate</td>
        </tr>
        <tr>
            <td>contract
            _pair@aggTrade</td>
            <td>btcinr@aggTrade</td>
            <td>aggTrade</td>
        </tr>
        <tr>
            <td>contract
            _pair@ticker</td>
            <td>btcinr@ticker</td>
            <td>24hrTicker</td>
        </tr>
        <tr>
            <td>contract
            _pair@marketInfo</td>
            <td>btcinr@marketInfo</td>
            <td>marketInfo</td>
        </tr>
        <tr>
            <td>markPriceArr</td>
            <td>N/A</td>
            <td>markPriceArr</td>
        </tr>
        <tr>
            <td>tickerArr</td>
            <td>N/A</td>
            <td>tickerArr</td>
        </tr>
        <tr>
            <td>All contracts details</td>
            <td>N/A</td>
            <td>allContractDetails</td>
        </tr>
</table>

<ul>
<li>Intervals: The intervals for kline (candlestick) data can be <code>1m</code>, <code>3m</code>, <code>5m</code>, <code>15m</code>, <code>30m</code>, <code>1h</code>, <code>2h</code>, <code>4h</code>, <code>6h</code>, <code>8h</code>, <code>12h</code>, <code>1d</code>, <code>3d</code>, <code>1w</code>, <code>1M</code>.</li>
<li>MinGroupings: Depth groupings vary by contract. For example, 0.1 is used for BTC.</li>
</ul>
<div class="highlight"><pre class="highlight plaintext"><code>import { io } from 'socket.io-client';

// WebSocket server URL
const serverUrl = 'https://fawss.pi42.com/';

// Create a new socket connection
const socket = io(serverUrl);

// Event listener for when the connection is open
socket.on('connect', () =&gt; {
  console.log('Connected to WebSocket server');
  subscribeToTopics();
});

// Event listener for when the connection is closed
socket.on('disconnect', () =&gt; {
  console.log('Disconnected from WebSocket server');
});

// Event listener for errors
socket.on('error', (error: any) =&gt; {
  console.error('Socket.IO error:', error);
});

// Function to subscribe to various WebSocket topics
function subscribeToTopics() {
  const topics = ['btcinr@depth_0.1', 'btcinr@markPrice']; // List of topics you want to subscribe to

  // Subscribe to each topic
  socket.emit('subscribe', {
    params: topics, // Sends the topics array to the WebSocket server
  });

  // Event listener for updates on various data topics
  socket.on('depthUpdate', (data) =&gt; {
    console.log('depthUpdate: ', data);
  });

  socket.on('kline', (data) =&gt; {
    console.log('kline: ', data);
  });

  socket.on('markPriceUpdate', (data) =&gt; {
    console.log('markPriceUpdate: ', data);
  });

  socket.on('aggTrade', (data) =&gt; {
    console.log('aggTrade: ', data);
  });

  socket.on('24hrTicker', (data) =&gt; {
    console.log('24hrTicker: ', data);
  });

  socket.on('marketInfo', (data) =&gt; {
    console.log('marketInfo: ', data);
  });

  socket.on('markPriceArr', (data) =&gt; {
    console.log('markPriceArr: ', data);
  });

  socket.on('tickerArr', (data) =&gt; {
    console.log('tickerArr: ', data);
  });

  socket.on('marginRate', (data) =&gt; {
    console.log('marginRate: ', data);
  });
}
</code></pre></div>
<h2 id="create-listen-key"> Create Listen Key </h2>

<p><code>POST /v1/retail/listen-key</code></p>

<p>Creates a new listen key for WebSocket connections. </p>

<p>A listen key is used to maintain a persistent connection to the WebSocket server, allowing you to receive real-time updates on user account data.</p>
<div class="highlight"><pre class="highlight plaintext"><code>const baseUrl = process.env.PI42_BASE_URL + '/v1/retail/listen-key';

// Function to generate a signature for the request
const generateSignature = (params: object, apiSecret: string) =&gt; {
  return crypto
    .createHmac('sha256', apiSecret)
    .update(JSON.stringify(params))
    .digest('hex');
};

// Function to call Create Listen Key API
async function createListenKey(apiKey: string, apiSecret: string) {
  const params = {
    timestamp: Date.now().toString(),
  };

  const signature = generateSignature(params, apiSecret);

  try {
    const response = await axios.post(baseUrl, params, {
      headers: {
        'api-key': apiKey,
        'Content-Type': 'application/json',
        'signature': signature,
      },
    });
    console.log('Create Listen Key Response:', response.data);
    return response.data.listenKey;
  } catch (error) {
    console.error(
      'Error creating Listen Key:',
      error.response ? error.response.data : error.message
    );
    throw error; // Rethrow the error for further handling
  }
}
</code></pre></div>
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>timestamp</td>
            <td>string</td>
            <td>Yes</td>
            <td>The current timestamp in milliseconds to ensure request uniqueness and prevent replay attacks</td>
        </tr>
    </tbody>
</table>

<p>The <code>createListenKey</code> function also requires an <code>apiKey</code> and <code>apiSecret</code> for authentication, and these are included in the headers of the request:</p>

<ul>
<li><code>apiKey</code>: The API key for authenticating the request.</li>
<li><code>apiSecret</code>: The API secret used to generate the signature for request validation.</li>
</ul>

<p>The function generates a signature using HMAC SHA-256 encryption of the request parameters and sends a POST request to the API endpoint to create a new listen key. If successful, it logs and returns the listen key; otherwise, it logs and throws the error for further handling.</p>
<h3 id='reponse'>Reponse</h3>
<p>The response parameters are described below:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">

</span><span class="p">{</span><span class="w">
  </span><span class="nl">"listenKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c44ec0b16e1e79d82473283a9736d2d037f105c39190ad48539fd6479a5b8ecc"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>listenKey</strong></td>
      <td>The unique identifier for the Listen Key, used to maintain a persistent connection for real-time data streams. Example: <code>c44ec0b16e1e79d82473283a9736d2d037f105c39190ad48539fd6479a5b8ecc</code>.</td>
    </tr>
  </tbody>
</table>

<h2 id="get-listen-key">Get Listen Key</h2>

<p><code>POST /v1/retail/listen-key</code></p>

<p>Retrieves a new listen key for WebSocket connections. </p>

<p>A listen key is used to maintain a persistent WebSocket connection, allowing you to receive real-time updates.</p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">getListenKey</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/v1/retail/listen-key</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// Call the postRequest function</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">postRequest</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="highlight python tab-python"><code><span class="k">def</span> <span class="nf">create_or_update_listen_key</span><span class="p">():</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span>
  <span class="p">}</span>

  <span class="c1"># Convert the parameters to a query string (if signing a query string)
</span>  <span class="n">data_to_sign</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">','</span><span class="p">,</span> <span class="s">':'</span><span class="p">))</span>
  <span class="n">signature</span> <span class="o">=</span> <span class="n">generate_signature</span><span class="p">(</span><span class="n">api_secret</span><span class="p">,</span> <span class="n">data_to_sign</span><span class="p">)</span>

  <span class="c1"># Headers for the request
</span>  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'api-key'</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
      <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
      <span class="s">'signature'</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Send the POST request to create or update a listen key
</span>      <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">listen_key_url</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
      <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
      <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
      <span class="k">print</span><span class="p">(</span><span class="s">'Listen key created or updated successfully:'</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
  <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>None</td>
            <td>N/A</td>
            <td>No</td>
            <td>Retrieves a new listen key for WebSocket connections. <br/>A listen key is used to maintain a persistent WebSocket connection, allowing you to receive real-time updates.</td>
        </tr>
    </tbody>
</table>

<h2 id="update-listen-key">Update Listen Key</h2>

<p><code>PUT /v1/retail/listen-key</code></p>

<p>Updates the listen key for WebSocket connections. </p>

<p>Updating the listen key is necessary to maintain an active WebSocket connection and prevent disconnections due to inactivity.</p>

<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>None</td>
            <td>N/A</td>
            <td>No</td>
            <td>Updates the listen key for WebSocket connections. </td>
        </tr>
    </tbody>
</table>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">updateListenKey</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/v1/retail/listen-key</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// Call the getRequest function</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">putRequest</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="highlight python tab-python"><code><span class="k">def</span> <span class="nf">update_listen_key_expiry</span><span class="p">():</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span>
  <span class="p">}</span>

  <span class="n">data_to_sign</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">','</span><span class="p">,</span> <span class="s">':'</span><span class="p">))</span>

  <span class="c1"># Generate the signature using the provided helper function
</span>  <span class="n">signature</span> <span class="o">=</span> <span class="n">generate_signature</span><span class="p">(</span><span class="n">api_secret</span><span class="p">,</span> <span class="n">data_to_sign</span><span class="p">)</span>

  <span class="c1"># Headers for the PUT request
</span>  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'api-key'</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
      <span class="s">'signature'</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Send the PUT request to update the listen key expiry
</span>      <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">listen_key_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="s">'Listen key expiry updated successfully:'</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
  <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div><h3 id='response'>Response</h3>
<p>The response contains a message as shown:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">
   </span><span class="err">Listen</span><span class="w"> </span><span class="err">Key</span><span class="w"> </span><span class="err">expiry</span><span class="w"> </span><span class="err">time</span><span class="w"> </span><span class="err">updated</span><span class="w"> </span><span class="err">successfully.</span><span class="w">

</span></code></pre></div>
<h2 id="delete-listen-key">Delete Listen Key</h2>

<p><code>DELETE /v1/retail/listen-key</code></p>

<p>Deletes the listen key for WebSocket connections.</p>

<p>This action terminates the connection and stops the receipt of real-time updates.</p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">deleteListenKey</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/v1/retail/listen-key</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// Call the deleteRequest function</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">deleteRequest</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="highlight python tab-python"><code><span class="k">def</span> <span class="nf">delete_listen_key</span><span class="p">():</span>
  <span class="c1"># Generate the current timestamp
</span>  <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

  <span class="c1"># Prepare the data for the request (listenKey is passed in the URL path)
</span>  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span>
  <span class="p">}</span>

  <span class="c1"># Generate the signature based on the params
</span>  <span class="n">data_to_sign</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">','</span><span class="p">,</span> <span class="s">':'</span><span class="p">))</span>
  <span class="n">signature</span> <span class="o">=</span> <span class="n">generate_signature</span><span class="p">(</span><span class="n">api_secret</span><span class="p">,</span> <span class="n">data_to_sign</span><span class="p">)</span>

  <span class="c1"># Headers for the DELETE request
</span>  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'api-key'</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
      <span class="s">'signature'</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
      <span class="s">'accept'</span><span class="p">:</span> <span class="s">'*/*'</span>
  <span class="p">}</span>

  <span class="c1"># Construct the full URL, inserting the listenKey into the path
</span>  <span class="n">delete_listen_key_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s">/v1/retail/listen-key/"</span>

  <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Send the DELETE request to delete the listen key
</span>      <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_listen_key_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
      <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span> <span class="c1"># Raises an error for 4xx/5xx responses
</span>      <span class="k">print</span><span class="p">(</span><span class="s">'Listen key deleted successfully.'</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: </span><span class="si">{</span><span class="n">err</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">err</span><span class="p">.</span><span class="n">response</span> <span class="k">else</span> <span class="n">err</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
  <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"An unexpected error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>None</td>
            <td>N/A</td>
            <td>No</td>
            <td>Deletes the listen key for WebSocket connections</td>
        </tr>
    </tbody>
</table>
<h3 id='response-2'>Response</h3>
<p>The response body contains the message as shown in the snippet:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Listen key deleted successfully.
</code></pre></div>